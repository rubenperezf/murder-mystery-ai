import { NextResponse } from 'next/server';
import { NextRequest } from 'next/server';

const mysteryTemplates = {
  en: [
  {
    setting: "Victorian Manor",
    victim: "Lady Margaret Blackwood",
    story: `The grand Victorian manor of Blackwood Estate fell under an ominous shadow when Lady Margaret Blackwood was discovered lifeless in her private study at 11:47 PM. The autumn storm raged outside, lightning illuminating the stained glass windows as Inspector Crawford began his meticulous examination of the crime scene.

Three individuals had been present that evening, each harboring secrets and motives. Professor James Hartford, the distinguished archaeologist, had arrived that morning to examine Lady Margaret's collection of ancient Roman artifacts. His weathered hands bore fresh scratches, which he claimed came from handling rough pottery shards earlier in the day. Miss Elena Rosetti, the newly hired Italian governess, possessed an intimate knowledge of poisons from her previous work in her family's apothecary shop in Florence. Charles Blackwood, Margaret's ambitious nephew and heir apparent, had been seen arguing with his aunt about his mounting gambling debts just hours before her death.

The crime scene revealed a complex web of evidence. In the study, Inspector Crawford found Lady Margaret slumped over her mahogany desk, a half-finished letter clutched in her hand warning someone about "fraudulent artifacts" and threatening to "expose the truth to the authorities." A crystal decanter containing her evening port sat nearby, its contents tainted with traces of oleander extract - a deadly poison that Miss Rosetti would know well from her botanical studies.

However, the most telling clue lay in the victim's appointment calendar, which showed a private meeting scheduled with "J.H." at 11:30 PM - precisely Professor Hartford's initials and close to the time of death. The Professor's archaeological tools were found hastily cleaned and returned to his travel case, though traces of blood remained on his metal excavation pick.

Charles's gambling markers were discovered hidden in Lady Margaret's desk drawer, suggesting she had been paying his debts. But more damning was the muddy boot print by the study window - a print that perfectly matched Charles's riding boots, indicating he had entered from outside during the storm to avoid being seen by the household staff.

The victim's final meal showed she had dined alone, dismissing the servants early - unusual behavior that suggested she was expecting someone she trusted. Miss Rosetti claimed to have been reading to young Sarah upstairs all evening, but the child later mentioned that "Miss Elena went away for a long time" after putting her to bed.

Physical evidence painted a clearer picture: defensive wounds on Lady Margaret's hands suggested a struggle, and her emerald ring was found beneath the Persian rug, as if knocked off during a violent encounter. The French doors to the garden showed fresh scratches around the lock, and wet footprints led directly to the study.

Most revealing was a torn piece of expensive paper found in the fireplace - partially burned correspondence that mentioned "archaeological forgeries" and bore the letterhead of a prestigious London auction house, suggesting someone had been selling counterfeit artifacts from Lady Margaret's collection.`,
    suspects: ["Professor James Hartford", "Miss Elena Rosetti", "Charles Blackwood"],
    weapons: ["Poison Extract", "Archaeological Pick", "Blunt Object"],
    locations: ["Study", "Garden", "Library"],
    solution: {
      suspect: "Professor James Hartford",
      weapon: "Archaeological Pick",
      location: "Study",
      explanation: "Professor Hartford killed Lady Margaret with his archaeological pick in the study. The evidence points to him: the appointment at 11:30 PM with 'J.H.', the hastily cleaned tools with blood traces, his scratched hands, and the burned correspondence about archaeological forgeries. Margaret had discovered he was selling fake artifacts from her collection and threatened to expose him, ending his career and reputation."
    }
  },
  {
    setting: "Modern Art Gallery",
    victim: "Alexandra Pierce", 
    story: `The prestigious Meridian Art Gallery's opening night celebration turned from triumph to tragedy when renowned art critic Alexandra Pierce was discovered dead at 10:45 PM in the sculpture wing. Detective Morgan arrived to find the victim surrounded by towering abstract sculptures, the city lights casting eerie shadows through the floor-to-ceiling windows.

The gallery had been buzzing with over two hundred guests, but three individuals stood out due to their complex relationships with the deceased. David Chen, a struggling sculptor whose latest exhibition had been savagely destroyed by Pierce's scathing review just two weeks prior, had been seen drinking heavily at the wine bar. His hands were stained with clay and traces of metal polish - evidence of his frantic last-minute work on a sculpture he'd hoped would redeem his reputation. Isabella Santos, the gallery's ambitious curator, wore an elegant black dress with suspicious white powder residue on the cuffs - powder that would later be identified as potassium cyanide. Marcus Reid, Pierce's former business partner, had been nervously checking his watch all evening and was overheard making hushed phone calls about "finalizing the deal tonight."

The crime scene told a compelling story. Pierce lay beside her signature champagne glass, its contents laced with a fast-acting poison that produced the telltale scent of bitter almonds. Her phone displayed an unsent message that read: "Isabella, I know what you've been doing with the provenance documents. Meet me in the sculpture wing at 10:30." 

Security footage revealed crucial timeline evidence: at 10:15 PM, Isabella was seen entering the sculpture wing carrying a champagne bottle, claiming later she was "refreshing the displays for VIP guests." However, the bottle she carried contained vintage Dom PÃ©rignon - Pierce's well-known preference, which Isabella would certainly know from years of working together.

The victim's notebook contained damning evidence about fraudulent authentication certificates for several major pieces in the gallery's permanent collection. Pierce had discovered that Isabella had been forging provenance documents to increase the value of questionable artworks, potentially defrauding collectors of millions.

David's alibi seemed solid initially - multiple witnesses saw him at the wine bar until 10:40 PM, just five minutes before the body was discovered. His sculpture tools were examined but showed no traces of poison or blood. Marcus Reid's phone records confirmed his calls were to legitimate art dealers in London, and his departure from the gallery was captured on external security cameras at 9:55 PM.

The most compelling evidence came from the victim's own meticulous documentation. Pierce had photographed several artworks with her phone that evening, including close-ups of forged signatures and authentication stamps. The timestamps on these photos ranged from 8:30 PM to 10:25 PM - just before she sent the fatal message to Isabella.

Additional evidence included Isabella's financial records, which showed significant deposits from offshore accounts linked to questionable art sales, and a hidden safe in her office containing blank authentication certificates and specialized chemical equipment for aging documents.`,
    suspects: ["David Chen", "Isabella Santos", "Marcus Reid"],
    weapons: ["Poisoned Champagne", "Sculptor's Tool", "Chemical Spray"],  
    locations: ["Sculpture Wing", "Wine Bar", "Curator's Office"],
    solution: {
      suspect: "Isabella Santos",
      weapon: "Poisoned Champagne",
      location: "Sculpture Wing", 
      explanation: "Isabella Santos poisoned Alexandra Pierce with cyanide-laced champagne in the sculpture wing. The evidence is overwhelming: Pierce's unsent message exposing Isabella's forgeries, the security footage showing Isabella carrying champagne to the sculpture wing, the white powder residue on Isabella's dress cuffs, and Pierce's documented evidence of the fraudulent authentication scheme. Isabella killed Pierce to protect her multi-million dollar art fraud operation."
    }
  },
  {
    setting: "Mountain Lodge",
    victim: "Dr. Robert Sterling",
    story: `The remote Alpine Lodge transformed from a peaceful research retreat into a crime scene when Dr. Robert Sterling, a prominent wildlife researcher, was found dead at 3:20 AM in the lodge's main cabin. The blizzard had intensified overnight, creating a perfect isolated environment as Sheriff Williams began her investigation by lamplight, the power having failed hours earlier.

Three colleagues had joined Sterling for what was supposed to be a collaborative weekend retreat. Dr. Sarah Mitchell, Sterling's former research partner, had been working late into the night on her laptop, her fingers stained with ink from handwritten notes about "data discrepancies" and "falsified research claims." Her background in biochemistry had given her extensive knowledge of various compounds and their effects on the human nervous system. Tom Bradley, an experienced hunting guide and conservationist, had been drinking heavily that evening, his hunting rifle leaning against the wall of his room - though notably, his prized hunting knife was missing from its custom leather sheath. Dr. Lisa Park, a veterinarian specializing in large mammals, had arrived with a medical bag containing various veterinary sedatives and had been seen earlier treating a wounded deer near the lodge's perimeter.

The victim was discovered slumped in his leather chair before the dying fireplace, his laptop open to a damning document titled "Research Fraud Evidence - S.M." The document contained detailed proof that Sarah had fabricated critical data in her wolf behavior studies, research that had won her a prestigious grant and academic position. Screenshots of altered spreadsheets and falsified field observations were meticulously documented.

Physical evidence painted a complex picture. An empty vial labeled "Ketamine HCl" was found beneath Sterling's chair - a powerful anesthetic that Dr. Park would have legitimate access to for veterinary procedures. However, the vial bore Sarah's fingerprints, not Park's, suggesting either direct involvement or deliberate framing. The victim's coffee mug contained traces of the same substance, indicating the drug had been administered orally.

Tom Bradley's hunting knife was eventually discovered outside, buried in fresh snow near the generator shed - the same location where someone had deliberately sabotaged the power supply to create darkness and confusion. The blade was clean, but the handle bore microscopic fibers from Sarah's wool sweater.

Sterling's phone revealed the most damning evidence: at 11:47 PM, he had sent a message to the university ethics board reading "Compelling evidence of research misconduct by Dr. S. Mitchell. Will submit full report Monday morning with documentation." The message timestamp was crucial - witnesses confirmed all three suspects were accounted for at that time, but Sarah had excused herself to "get more coffee" shortly after.

The investigation revealed Sarah's motive went beyond career preservation. Sterling's evidence would not only destroy her reputation but also trigger criminal fraud charges, as her falsified research had influenced federal wildlife protection policies. Security camera footage from the lodge's entrance showed Sarah leaving her room at 2:55 AM - just twenty-five minutes before Sterling's estimated time of death.

Most tellingly, Sarah's laptop browser history showed desperate late-night searches for "ketamine overdose symptoms" and "untraceable administration methods" conducted just hours before the murder. Her notebook contained calculations for lethal dosages based on Sterling's approximate weight and age.`,
    suspects: ["Dr. Sarah Mitchell", "Tom Bradley", "Dr. Lisa Park"],
    weapons: ["Veterinary Sedative", "Hunting Knife", "Toxic Compound"],
    locations: ["Main Cabin", "Generator Shed", "Outside Lodge"],
    solution: {
      suspect: "Dr. Sarah Mitchell", 
      weapon: "Veterinary Sedative",
      location: "Main Cabin",
      explanation: "Dr. Sarah Mitchell killed Dr. Sterling with veterinary ketamine in the main cabin. The evidence is conclusive: Sterling's laptop contained her research fraud documentation, her fingerprints on the ketamine vial, the message to ethics board at 11:47 PM, her late-night internet searches about ketamine overdoses, security footage showing her leaving her room at 2:55 AM, and fibers from her sweater on the planted knife. She murdered Sterling to prevent him from exposing her career-ending research fraud."
    }
  }
  ],
  es: [
    {
      setting: "MansiÃ³n Victoriana",
      victim: "Lady Margarita ValdÃ©s",
      story: `La gran mansiÃ³n victoriana de la hacienda ValdÃ©s se sumiÃ³ en una sombra ominosa cuando Lady Margarita ValdÃ©s fue descubierta sin vida en su estudio privado a las 11:47 PM. La tormenta otoÃ±al arreciaba afuera, los relÃ¡mpagos iluminando las ventanas emplomadas mientras el Inspector GarcÃ­a comenzaba su meticuloso examen de la escena del crimen.

Tres individuos habÃ­an estado presentes esa noche, cada uno albergando secretos y motivos. El Profesor AndrÃ©s Herrera, el distinguido arqueÃ³logo, habÃ­a llegado esa maÃ±ana para examinar la colecciÃ³n de artefactos romanos antiguos de Lady Margarita. Sus manos curtidas mostraban rasguÃ±os frescos, que Ã©l afirmaba provenÃ­an de manipular fragmentos de cerÃ¡mica rugosa mÃ¡s temprano en el dÃ­a. La SeÃ±orita Carmen Silva, la institutriz italiana reciÃ©n contratada, poseÃ­a un conocimiento Ã­ntimo de venenos por su trabajo previo en la farmacia de su familia en Florencia. Carlos ValdÃ©s, el ambicioso sobrino de Margarita y heredero aparente, habÃ­a sido visto discutiendo con su tÃ­a sobre sus crecientes deudas de juego apenas unas horas antes de su muerte.

La escena del crimen revelÃ³ una compleja red de evidencia. En el estudio, el Inspector GarcÃ­a encontrÃ³ a Lady Margarita desplomada sobre su escritorio de caoba, una carta a medio terminar apretada en su mano advirtiendo a alguien sobre "artefactos fraudulentos" y amenazando con "exponer la verdad a las autoridades." Una licorera de cristal conteniendo su oporto nocturno yacÃ­a cerca, su contenido contaminado con trazas de extracto de adelfa - un veneno mortal que la SeÃ±orita Silva conocerÃ­a bien de sus estudios botÃ¡nicos.

Sin embargo, la pista mÃ¡s reveladora yacÃ­a en el calendario de citas de la vÃ­ctima, que mostraba una reuniÃ³n privada programada con "A.H." a las 11:30 PM - precisamente las iniciales del Profesor Herrera y cercano al momento de la muerte. Las herramientas arqueolÃ³gicas del Profesor fueron encontradas limpiadas apresuradamente y devueltas a su maletÃ­n de viaje, aunque quedaron rastros de sangre en su pico de excavaciÃ³n metÃ¡lico.

Los resguardos de juego de Carlos fueron descubiertos escondidos en el cajÃ³n del escritorio de Lady Margarita, sugiriendo que ella habÃ­a estado pagando sus deudas. Pero mÃ¡s condenatorio era la huella de bota lodosa junto a la ventana del estudio - una huella que coincidÃ­a perfectamente con las botas de montar de Carlos, indicando que habÃ­a entrado desde afuera durante la tormenta para evitar ser visto por el personal de la casa.

La Ãºltima comida de la vÃ­ctima mostrÃ³ que habÃ­a cenado sola, despidiendo a los sirvientes temprano - comportamiento inusual que sugerÃ­a que estaba esperando a alguien en quien confiaba. La SeÃ±orita Silva afirmÃ³ haber estado leyendo a la pequeÃ±a Sarah arriba toda la noche, pero la niÃ±a despuÃ©s mencionÃ³ que "SeÃ±orita Carmen se fue por mucho tiempo" despuÃ©s de acostarla.

La evidencia fÃ­sica pintaba un cuadro mÃ¡s claro: heridas defensivas en las manos de Lady Margarita sugerÃ­an una lucha, y su anillo de esmeralda fue encontrado bajo la alfombra persa, como si hubiera sido arrancado durante un encuentro violento. Las puertas francesas al jardÃ­n mostraban rasguÃ±os frescos alrededor de la cerradura, y huellas hÃºmedas conducÃ­an directamente al estudio.

La mÃ¡s reveladora fue una pieza de papel caro desgarrada encontrada en la chimenea - correspondencia parcialmente quemada que mencionaba "falsificaciones arqueolÃ³gicas" y portaba el membrete de una prestigiosa casa de subastas de Londres, sugiriendo que alguien habÃ­a estado vendiendo artefactos falsificados de la colecciÃ³n de Lady Margarita.`,
      suspects: ["Profesor AndrÃ©s Herrera", "SeÃ±orita Carmen Silva", "Carlos ValdÃ©s"],
      weapons: ["Extracto Venenoso", "Pico ArqueolÃ³gico", "Objeto Contundente"],
      locations: ["Estudio", "JardÃ­n", "Biblioteca"],
      solution: {
        suspect: "Profesor AndrÃ©s Herrera",
        weapon: "Pico ArqueolÃ³gico",
        location: "Estudio",
        explanation: "El Profesor Herrera matÃ³ a Lady Margarita con su pico arqueolÃ³gico en el estudio. La evidencia lo seÃ±ala: la cita a las 11:30 PM con 'A.H.', las herramientas limpiadas apresuradamente con rastros de sangre, sus manos rasguÃ±adas, y la correspondencia quemada sobre falsificaciones arqueolÃ³gicas. Margarita habÃ­a descubierto que Ã©l estaba vendiendo artefactos falsos de su colecciÃ³n y amenazÃ³ con exponerlo, terminando su carrera y reputaciÃ³n."
      }
    },
    {
      setting: "GalerÃ­a de Arte Moderna",
      victim: "Alejandra Morales",
      story: `La prestigiosa GalerÃ­a de Arte Meridiano se convirtiÃ³ en escena de tragedia durante la celebraciÃ³n de inauguraciÃ³n cuando la reconocida crÃ­tica de arte Alejandra Morales fue encontrada muerta en el ala de esculturas. Las luces de la ciudad parpadeaban a travÃ©s de las ventanas del piso al techo mientras la Detective LÃ³pez examinaba la escena, desconcertada por la evidencia inusual.

Tres individuos tuvieron interacciones significativas con Morales esa noche: Diego Ruiz, un artista en apuros cuyo trabajo habÃ­a sido duramente criticado por Morales el mes pasado; Isabella Santos, la ambiciosa curadora de la galerÃ­a que habÃ­a estado en disputa con Morales sobre las elecciones de exposiciÃ³n; y Miguel Torres, el ex socio comercial de Morales que habÃ­a estado envuelto en una amarga demanda por atribuciones de obras de arte robadas.

Varios elementos sospechosos llamaron la atenciÃ³n de la detective: una copa de vino que contenÃ­a trazas de una toxina de acciÃ³n rÃ¡pida yacÃ­a abandonada cerca de la instalaciÃ³n de arte moderno. Un cincel de escultor afilado habÃ­a desaparecido del espacio de trabajo del artista. Las cÃ¡maras de seguridad mostraron que alguien habÃ­a manipulado la salida de emergencia en el ala este. El telÃ©fono de la vÃ­ctima contenÃ­a un mensaje de amenaza recibido pocas horas antes de su muerte.

Diego fue escuchado discutiendo con Morales cerca del bar de vinos alrededor de las nueve y media. Isabella afirmÃ³ que estaba dando tours a invitados VIP durante el perÃ­odo crucial. Miguel insistiÃ³ que se fue temprano debido a un dolor de cabeza repentino, aunque su tarjeta de acceso mostrÃ³ actividad posterior en el edificio.`,
      suspects: ["Diego Ruiz", "Isabella Santos", "Miguel Torres"],
      weapons: ["Vino Envenenado", "Cincel de Escultor", "Pintura TÃ³xica"],
      locations: ["Ala de Esculturas", "Bar de Vinos", "Ala Este"],
      solution: {
        suspect: "Isabella Santos",
        weapon: "Vino Envenenado",
        location: "Ala de Esculturas",
        explanation: "Isabella Santos envenenÃ³ el vino de Alejandra Morales en el ala de esculturas. Como curadora, tenÃ­a acceso a todas las Ã¡reas y conocÃ­a los hÃ¡bitos de Morales. UsÃ³ el tour VIP como cobertura, escapÃ¡ndose para cometer el asesinato mientras mantenÃ­a su coartada."
      }
    },
    {
      setting: "Refugio de MontaÃ±a",
      victim: "Dr. Roberto Valdez",
      story: `El refugio alpino remoto se convirtiÃ³ en escena de misterio cuando el Dr. Roberto Valdez, un prominente investigador de vida silvestre, fue descubierto muerto en la cabaÃ±a principal del refugio. La nieve continuaba cayendo copiosamente afuera, cortando todos los caminos mientras la Sheriff Williams comenzÃ³ a investigar la escena del crimen aislada.

Tres huÃ©spedes se habÃ­an estado quedando en el refugio ese fin de semana: Sara Mendoza, la ex compaÃ±era de investigaciÃ³n de Valdez que lo habÃ­a acusado de robar sus datos revolucionarios sobre comportamiento de lobos; TomÃ¡s Herrera, un guÃ­a de caza que habÃ­a estado en conflicto con Valdez sobre polÃ­ticas de conservaciÃ³n de vida silvestre; y la Dra. Lisa Moreno, una veterinaria que habÃ­a estado colaborando con Valdez en un controvertido proyecto de pruebas en animales.

La sheriff notÃ³ varias pistas peculiares: un frasco de tranquilizante animal fue descubierto vacÃ­o cerca de la chimenea, su contenido claramente habÃ­a sido usado. Un cuchillo de caza de la colecciÃ³n de Herrera fue encontrado limpio y reemplazado en la vaina equivocada. Huellas de neumÃ¡ticos frescas en la nieve sugerÃ­an que alguien habÃ­a intentado irse durante la noche. La laptop de la vÃ­ctima mostraba que habÃ­a estado preparÃ¡ndose para exponer las actividades ilegales de alguien.

Sara fue vista en discusiÃ³n acalorada con Valdez sobre Ã©tica de investigaciÃ³n justo antes de la cena. TomÃ¡s afirmÃ³ que estaba en su habitaciÃ³n limpiando equipo, pero sonidos de una discusiÃ³n resonaron desde la cabaÃ±a principal alrededor de medianoche. La Dra. Moreno sostuvo que estaba sedando un venado herido que habÃ­a encontrado, explicando sus movimientos nocturnos afuera.`,
      suspects: ["Sara Mendoza", "TomÃ¡s Herrera", "Dra. Lisa Moreno"],
      weapons: ["Tranquilizante Animal", "Cuchillo de Caza", "Planta TÃ³xica"],
      locations: ["CabaÃ±a Principal", "Cuarto de Equipos", "Afuera del Refugio"],
      solution: {
        suspect: "Sara Mendoza",
        weapon: "Tranquilizante Animal",
        location: "CabaÃ±a Principal",
        explanation: "Sara Mendoza usÃ³ tranquilizante animal para matar al Dr. Valdez en la cabaÃ±a principal. Estaba desesperada por evitar que Ã©l expusiera sus datos de investigaciÃ³n falsificados. Su conocimiento de sedantes para animales lo convirtiÃ³ en el arma perfecta, e intentÃ³ incriminar a TomÃ¡s plantando evidencia."
      }
    }
  ]
};

export async function GET(request: NextRequest) {
  // Get language parameter from URL
  const { searchParams } = new URL(request.url);
  const lang = searchParams.get('lang') || 'en';
  const language = (lang === 'es') ? 'es' : 'en';
  
  try {

    // In a real implementation, you would make an API call to Claude here:
    // const claudeResponse = await fetch('https://api.anthropic.com/v1/messages', {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json',
    //     'x-api-key': process.env.CLAUDE_API_KEY,
    //   },
    //   body: JSON.stringify({
    //     model: 'claude-3-sonnet-20240229',
    //     max_tokens: 2000,
    //     messages: [{
    //       role: 'user',
    //       content: `You are an AI mystery writer competing against human players in a detective game. Create a sophisticated murder mystery story of exactly 500 words in ${language === 'es' ? 'Spanish' : 'English'}.

    //       CRITICAL REQUIREMENTS:
    //       1. The story must contain LOGICAL CLUES that point to the correct solution
    //       2. Include red herrings that could mislead players, but the real clues must be stronger
    //       3. The murder weapon, location, and perpetrator must be deducible from evidence in the story
    //       4. Include specific details like times, physical evidence, alibis, motives, and contradictions
    //       5. Make it challenging but fair - a careful reader should be able to solve it

    //       STRUCTURE:
    //       - 3 suspects with clear motives and opportunity
    //       - 3 possible weapons that make logical sense
    //       - 3 locations where the crime could have occurred
    //       - Physical evidence (fingerprints, DNA, fibers, tools, etc.)
    //       - Digital evidence (phones, cameras, computers, messages)
    //       - Timeline inconsistencies and alibi contradictions
    //       - Witness testimonies that may conflict

    //       EVIDENCE INTEGRATION:
    //       - The correct suspect must have: strongest motive + opportunity + physical evidence linking them
    //       - Include at least 5 specific clues that point to the real killer
    //       - Add 3-4 red herrings that initially seem suspicious but have explanations
    //       - Make the timeline crucial - include specific times and locations

    //       Return ONLY a JSON object with this exact format:
    //       {
    //         "story": "500-word mystery story text here",
    //         "suspects": ["Suspect 1", "Suspect 2", "Suspect 3"],
    //         "weapons": ["Weapon 1", "Weapon 2", "Weapon 3"],
    //         "locations": ["Location 1", "Location 2", "Location 3"],
    //         "solution": {
    //           "suspect": "Correct suspect name",
    //           "weapon": "Correct weapon",
    //           "location": "Correct location",
    //           "explanation": "Detailed explanation listing the 5+ clues that prove this solution"
    //         }
    //       }`
    //     }]
    //   })
    // });

    // For now, return a random template from the selected language
    const templates = mysteryTemplates[language];
    const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
    
    // Add some randomization to make each mystery feel unique
    const shuffledSuspects = [...randomTemplate.suspects].sort(() => Math.random() - 0.5);
    const shuffledWeapons = [...randomTemplate.weapons].sort(() => Math.random() - 0.5);  
    const shuffledLocations = [...randomTemplate.locations].sort(() => Math.random() - 0.5);
    
    return NextResponse.json({
      story: randomTemplate.story,
      suspects: shuffledSuspects,
      weapons: shuffledWeapons,
      locations: shuffledLocations,
      solution: randomTemplate.solution
    });
  } catch (error) {
    console.error('Error generating mystery:', error);
    
    // Fallback mystery if something goes wrong
    const fallbackMystery = language === 'es' ? {
      story: `El pequeÃ±o pueblo costero de Puerto Sereno se transformÃ³ de paraÃ­so tranquilo a escena del crimen cuando la Alcaldesa Patricia Vega fue encontrada muerta a las 9:30 PM en su oficina del Ayuntamiento. La espesa niebla marina habÃ­a envuelto el edificio, proporcionando cobertura perfecta mientras el Detective MartÃ­nez iniciaba su investigaciÃ³n bajo la tenue luz de emergencia.

Tres individuos tenÃ­an motivos poderosos para eliminar a la alcaldesa. Guillermo Torres, el contratista corrupto, habÃ­a estado bebiendo pesadamente esa noche, sus manos manchadas de yeso y cemento - evidencia de su desesperado trabajo nocturno para ocultar construcciones ilegales antes de la inspecciÃ³n programada de Vega para el dÃ­a siguiente. Jennifer LÃ³pez, la vicealcaldesa ambiciosa, llevaba un elegante vestido negro con residuos sospechosos de polvo blanco en los puÃ±os - polvo que serÃ­a identificado como cianuro potÃ¡sico. Francisco Morales, el empresario despechado, habÃ­a estado revisando nerviosamente su reloj toda la noche y fue escuchado haciendo llamadas susurradas sobre "finalizar el trato esta noche."

La escena del crimen revelÃ³ una historia convincente. Vega yacÃ­a junto a su taza de cafÃ© caracterÃ­stica, su contenido mezclado con un veneno de acciÃ³n rÃ¡pida que producÃ­a el inconfundible aroma de almendras amargas. Su telÃ©fono mostraba un mensaje no enviado que decÃ­a: "Jennifer, sÃ© lo que has estado haciendo con los documentos presupuestarios. ReÃºnete conmigo en mi oficina a las 9:00 PM."

Las grabaciones de seguridad revelaron evidencia crucial del cronograma: a las 8:45 PM, Jennifer fue vista entrando a la oficina portando una cafetera, alegando despuÃ©s que estaba "refrescando el cafÃ© para la reuniÃ³n nocturna." Sin embargo, la cafetera contenÃ­a cafÃ© colombiano premium - la preferencia conocida de Vega, que Jennifer ciertamente sabrÃ­a despuÃ©s de aÃ±os trabajando juntas.

El cuaderno de Vega contenÃ­a evidencia devastadora sobre certificados de autenticidad fraudulentos para varios contratos municipales importantes. Vega habÃ­a descubierto que LÃ³pez habÃ­a estado falsificando documentos presupuestarios para desviar fondos municipales a cuentas personales, potencialmente defraudando al pueblo por millones.

La coartada de Torres parecÃ­a sÃ³lida inicialmente - mÃºltiples testigos lo vieron en el bar municipal hasta las 9:25 PM, apenas cinco minutos antes de que el cuerpo fuera descubierto. Los registros telefÃ³nicos de Morales confirmaron que sus llamadas eran a desarrolladores legÃ­timos en Madrid, y su salida del ayuntamiento fue capturada por cÃ¡maras externas a las 8:50 PM.

La evidencia mÃ¡s convincente provino de la propia documentaciÃ³n meticulosa de Vega. HabÃ­a fotografiado varios documentos presupuestarios con su telÃ©fono esa noche, incluyendo primeros planos de firmas falsificadas y sellos de autenticaciÃ³n. Las marcas de tiempo en estas fotos iban desde las 7:30 PM hasta las 8:55 PM - justo antes de enviar el mensaje fatal a LÃ³pez.

Evidencia adicional incluyÃ³ los registros financieros de LÃ³pez, que mostraban depÃ³sitos significativos de cuentas offshore vinculadas a contratos municipales cuestionables, y una caja fuerte oculta en su oficina conteniendo certificados presupuestarios en blanco y equipo quÃ­mico especializado para envejecer documentos.`,
      suspects: ["Guillermo Torres", "Jennifer LÃ³pez", "Francisco Morales"],
      weapons: ["CafÃ© Envenenado", "Abrecartas", "Planta TÃ³xica"],
      locations: ["Oficina de la Alcaldesa", "Ayuntamiento", "Estacionamiento"],
      solution: {
        suspect: "Jennifer LÃ³pez",
        weapon: "CafÃ© Envenenado",
        location: "Oficina de la Alcaldesa",
        explanation: "Jennifer LÃ³pez envenenÃ³ a Patricia Vega con cianuro en el cafÃ© en la oficina de la alcaldesa. La evidencia es abrumadora: el mensaje no enviado de Vega exponiendo las falsificaciones de LÃ³pez, las grabaciones de seguridad mostrando a LÃ³pez llevando cafÃ© a la oficina a las 8:45 PM, el residuo de polvo blanco en los puÃ±os de su vestido, y la evidencia documentada de Vega del esquema fraudulento presupuestario. LÃ³pez matÃ³ a Vega para proteger su operaciÃ³n de fraude municipal de varios millones."
      }
    } : {
      story: `The small coastal town of Seaside Harbor was shocked when Mayor Patricia Wells was found dead in her office at City Hall. The fog had rolled in thick that evening, providing perfect cover for the perpetrator as Police Chief Martinez began his investigation.

Three individuals had reason to want Mayor Wells gone: Gary Thompson, a corrupt contractor whose illegal building permits Wells had recently discovered; Jennifer Liu, the deputy mayor who'd been passed over for promotion multiple times; and Frank Morrison, a local business owner whose waterfront development had been blocked by Wells' environmental policies.

Evidence at the scene painted a confusing picture: a coffee mug containing traces of deadly nightshade sat on the mayor's desk. A letter opener from the city seal collection was missing from its display case. Security footage showed someone had disabled the cameras in the parking garage. Wells' calendar revealed she'd been planning to meet someone secretly that evening.

Thompson was overheard threatening Wells at the town council meeting. Liu claimed she was working late on budget reports in her adjacent office. Morrison insisted he was at home with his wife, though neighbors reported seeing his car downtown much later than he claimed.`,
      suspects: ["Gary Thompson", "Jennifer Liu", "Frank Morrison"],
      weapons: ["Poisoned Coffee", "Letter Opener", "Toxic Plant"],
      locations: ["Mayor's Office", "City Hall", "Parking Garage"],
      solution: {
        suspect: "Jennifer Liu",
        weapon: "Poisoned Coffee",
        location: "Mayor's Office",
        explanation: "Deputy Mayor Jennifer Liu poisoned Patricia Wells' coffee in the mayor's office. Her proximity and access made it easy to slip the nightshade into Wells' evening coffee, and she used her late work as the perfect alibi while planning her ascension to mayor."
      }
    };

    return NextResponse.json(fallbackMystery);
  }
}